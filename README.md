#SmartQuant Pro - A股智能量化决策系统
SmartQuant Pro 是一个集成本地数据仓库、实时行情监控、持仓管理以及 LLM（大语言模型）智能投研决策于一体的量化辅助系统。系统利用 Streamlit 构建交互式前端，后端集成多源数据采集（Tushare/AkShare/Sina），并通过 OpenAI 兼容接口调用 DeepSeek、Qwen 等模型进行深度市场分析。
---
##📅 开发过程总结
本项目的开发经历了四个主要阶段，从基础的数据管理逐步进化为自动化的 AI 决策平台：

###基础架构搭建：

* 构建了基于 Streamlit 的前端界面。

* 实现了 `portfolio.py` 用于 JSON 格式的本地持仓管理，支持 T+1 交易规则和资金计算。

* 封装了 `data_manager.py`，实现了从新浪财经获取实时行情的基础能力。

###数据仓库与多源容灾：

* 引入 Tushare 和 AkShare，建立了本地 CSV 历史数据仓库。

* **核心痛点解决**：针对 Tushare 的积分限频问题，开发了多 Token 轮换机制和指数退避重试逻辑，确保全量 A 股数据下载的稳定性。

* 实现了“全量初始化”与“每日增量更新”的数据维护策略。

###AI 引擎与策略集成：

* 开发 ai_engine.py，设计了动态 Prompt 构建器，能够根据用户选择的策略（激进/稳健/动态）自动组装持仓数据和技术指标。

* 实现了**批量聚合分析**，将所有持仓打包为一次 API 请求，大幅降低 Token 消耗并提升分析效率。

* 增加了对多种国产大模型（DeepSeek, 通义千问, 腾讯混元等）的适配支持。

###自动化调度与并发优化：

* 开发 `ai_scheduler.py`，利用 `APScheduler` 实现后台定时任务。

* **关键技术突破**：解决了 Streamlit 线程上下文丢失问题，实现了前端 UI 不阻塞的情况下执行耗时的数据清洗任务，并能实时反馈进度。

* 完善了跨进程通信（PID 文件管理）和系统通知（Windows 弹窗）。
---
##💡 遇到的问题与技术创新点
在开发过程中，我们攻克了以下关键技术难题：

###1. Streamlit 线程上下文丢失 (Context Loss)
* 问题：在点击“数据更新”按钮启动后台线程时，报错 `missing ScriptRunContext`，导致后台线程无法更新前端状态条，用户无法感知进度。

* 创新解法：引入 `streamlit.runtime.scriptrunner.add_script_run_ctx`，显式地将主线程的运行上下文注入到子线程中。这使得后台爬虫任务既不阻塞 UI 渲染，又能实时向前端推送 `st.session_state` 的状态变更。

###2. Tushare 接口高并发限频
* 问题：在下载 5000+ 只股票历史数据时，极易触发 API 频率限制，导致任务中断。

* 创新解法：设计了 **Token 轮换调度器 (TokenScheduler)**。

 * 配置池化：支持配置多个 API Token。

 * 自动切换：捕获特定错误码，一旦当前 Token 被限流，自动无缝切换至下一个。

 * 指数退避：所有 Token 均耗尽时，启用指数级等待策略，实现无人值守的工业级下载。

###3. AI 输出格式非结构化
* 问题：大模型（特别是参数较小的模型）返回的 JSON 经常包含 Markdown 标记（\`\`\`json）或单引号错误，导致 Python 解析崩溃。

* 创新解法：

 * 正则提取：使用 `re.search(r'\{.*\}', text, re.DOTALL)` 剥离无关文本。

 * 容错修正：自动替换非标准单引号，增加 `try-catch` 重试机制。

 * 结构校验：强制检查 `action` 等关键字段，缺失则返回默认的安全策略（HOLD），保证系统健壮性。

###4. 进程与资源管理
* 问题：如何在 Streamlit 这种无状态 Web 框架中管理持久化的后台调度进程？

* 解法：采用 **PID 文件锁** 机制。启动后台调度器时记录 PID，使用 `subprocess.Popen` 配合 `CREATE_NEW_CONSOLE` (Windows) 标志，使后台任务拥有独立窗口以便调试，同时通过检测 PID 存活状态来防止多重启动。
---
##🛠️ 核心技术栈
* **前端框架**: Streamlit (响应式 Web UI)

* **数据处理**: Pandas (清洗/计算), NumPy

* **数据采集**: Tushare Pro (历史数据), AkShare/BaoStock/Sina (实时/灾备)

* **AI 交互**: OpenAI SDK (兼容层), Prompt Engineering (角色扮演/CoT)

* **任务调度**: APScheduler (定时任务), Threading (异步任务), Subprocess (进程守护)

* **系统交互**: Plyer (桌面通知)
---
##✨ 功能介绍
* **📊 市场全景**：支持切换 Sina/AkShare/BaoStock/TuShare 四大数据源，实时查看指数行情，自动高亮涨跌。

* **🤖 智能决策**：

 * 支持选择不同风险偏好的策略（激进/稳健/动态）。

 * **后台调度**：一键启动后台 AI 监控，周期性分析持仓。

 * **调试模式**：提供 Prompt 预览功能，无需消耗 Token 即可检查发送给 AI 的数据格式。

* **📂 数据仓库 & 选股**：

 * **全量初始化**：支持断点续传和自动备份的多 Token 历史数据下载。

 * **每日更新**：智能增量更新当日数据，自动对齐 CSV 列格式。

 * **本地选股**：内置“一夜持股法”和“打板策略”，基于本地数据快速筛选标的。

* **💰 资产管理**：可视化的持仓表格，支持手动录入成本、股数，自动计算 T+1 可用股数和浮动盈亏。

* **⚙️ 系统设置**：

 * 支持配置 DeepSeek、Qwen、OpenAI 等 10+ 种大模型接口。

 * 可视化配置 API Key 和 Base URL。
---
##🖥️ 系统要求
* **操作系统**: Windows 10/11 (推荐，支持弹窗和独立控制台)

* **Python 版本**: Python 3.8 ~ 3.11

##⚙️ 环境配置过程
* **克隆或下载代码**

* **安装依赖**

 * 双击运行`setup.bat`，安装python依赖库。

* **准备 API Key**

 * **Tushare**: 注册 获取 Token (建议准备 2-3 个以防限频)。

 * **AI 模型**: 申请 DeepSeek 或 阿里云 DashScope 等服务的 API Key。
---
##🚀 如何启动
* **启动主程序**：

双击运行`start.bat`，系统会自动在默认浏览器中打开 `http://localhost:8501`。

* **初始化配置**：

 * 进入 **⚙️ 系统设置** 页面。

 * 填写 **AI 模型配置** (推荐 DeepSeek)。

 * 填写 **TuShare Token** (多个用逗号分隔)。

 * 点击**保存全部设置**。

* 初始化数据：

 * 进入 **📂 数据仓库 & 选股** 页面。

 * 点击 **🛠️ 全量历史数据初始化**，等待控制台显示完成（首次运行需较长时间）。

* 开启 AI 决策：

 * 在 **💰 资产管理** 中录入您的持仓。

 * 进入 **🤖 智能决策 & 机会**，选择策略，点击 **🚀 启动 AI 调度**。
